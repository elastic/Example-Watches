{
    "metadata": {
      "window_width": "30m",
      "time_period": "30s"
    },
    "trigger": {
      "schedule": {
        "interval": "30s"
      }
    },
    "input": {
      "chain": {
        "inputs": [
        {
          "get_time_period": {
            "search": {
              "request": {
                "indices": [
                  "log"
                ],
                "body": {
                  "size": 1,
                  "script_fields": {
                    "upper_time": {
                      "script": {
                        "inline": "return LocalDateTime.parse(params.current_time.substring(0,19)).plusMinutes(30).format(DateTimeFormatter.ofPattern('HH:mm:ss'))+'Z';",
                        "params": {
                          "current_time": "{{ctx.trigger.triggered_time}}"
                        }
                      }
                    },
                    "lower_time": {
                      "script": {
                        "inline": "return LocalDateTime.parse(params.current_time.substring(0,19)).minusMinutes(30).format(DateTimeFormatter.ofPattern('HH:mm:ss'))+'Z';",
                        "params" : {
                          "current_time": "{{ctx.trigger.triggered_time}}"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "user_server_logons": {
            "search": {
              "request": {
                "indices": [
                  "log"
                ],
                "body": {
                  "query": {
                    "range": {
                      "@timestamp": {
                        "gte": "now-{{ctx.metadata.time_period}}"
                      }
                    }
                  },
                  "aggs": {
                    "user_server": {
                      "terms": {
                        "field": "user_server",
                        "size": 1000
                      }
                    }
                  },
                  "size": 0
                }
              }
            }
          },
          "new_user_server_logons": {
            "search": {
              "request": {
                "indices": [
                  "log"
                ],
                "body": {
                  "query": {
                    "bool": {
                      "filter": [


                        
                        {
                          "range": {
                            "time": {
                              "gte": "{{ctx.payload.get_time_period.hits.hits.0.fields.lower_time.0}}",
                              "lte": "{{ctx.payload.get_time_period.hits.hits.0.fields.upper_time.0}}"
                            }
                          }
                        },
                        {
                          "terms": {
                            "user_server": [
                              "{{#ctx.payload.user_server_logons.aggregations.user_server.buckets}}{{key}}",
                              "{{/ctx.payload.user_server_logons.aggregations.user_server.buckets}}"
                            ]
                          }
                        },
                        {
                          "range": {
                            "@timestamp": {
                              "lt": "now/d"
                            }
                          }
                        }
                      ]
                    }
                  },
                  "aggs": {
                    "user_server": {
                      "terms": {
                        "field": "user_server",
                        "size": 1000
                      }
                    }
                  },
                  "size": 0
                }
              }
            }
          }
        }
      ]
    }
    },
    "condition": {
      "script": {
        "inline":"return ctx.payload.user_server_logons.aggregations.user_server.buckets.size() != ctx.payload.new_user_server_logons.aggregations.user_server.buckets.size();"
      }
    },
    "transform": {
      "script": {
        "inline":"def history = ctx.payload.new_user_server_logons.aggregations.user_server.buckets.stream().map(p -> p.key).collect(Collectors.toList()); def response=[:]; response['lower_time']=ctx.payload.get_time_period.hits.hits[0].fields.lower_time[0]; response['upper_time']=ctx.payload.get_time_period.hits.hits[0].fields.upper_time[0]; response['new_starts']=ctx.payload.user_server_logons.aggregations.user_server.buckets.stream().map(p -> p.key).filter(p -> !history.contains(p)).map(p -> p.replace('_',' on server ')).collect(Collectors.toList());  return response"
      }
    },
    "actions": {
      "log": {
        "logging": {
          "text": "{{ctx.metadata.triggered_time}}The following users have logged onto a new server for the first time within the time period: {{#ctx.payload.new_starts}}{{.}}:{{/ctx.payload.new_starts}}"
        }
      }
    }
  }