{
    "metadata": {
        "threshold": 5,
        "interval": "2m",
        "window": "4m"
    },
    "trigger": {
        "schedule": {
            "interval": "2m"
        }
    },
    "input": {
        "search": {
            "request": {
                "search_type": "query_then_fetch",
                "indices": [
                    "topbeat-*"
                ],
                "types": [
                    "system"
                ],
                "body": {
                  "size": 0,
                  "aggs": {
                    "per_host": {
                      "aggs": {
                        "per_minute": {
                          "date_histogram": {
                            "field": "@timestamp",
                            "interval": "{{ctx.metadata.interval}}"
                          },
                          "aggs": {
                            "iowait": {
                              "max": {
                                "script": {
                                  "inline":"(doc['cpu.iowait'].value\/(doc['cpu.user'].value + doc['cpu.nice'].value + doc['cpu.system'].value + doc['cpu.idle'].value + doc['cpu.iowait'].value + doc['cpu.irq'].value + doc['cpu.softirq'].value + doc['cpu.steal'].value))*100"
                                }
                              }
                            },
                            "iowait_deriv": {
                              "derivative": {
                                "buckets_path": "iowait"
                              }
                            }
                          }
                        }
                      },
                      "terms": {
                        "size": 10,
                        "field": "beat.hostname"
                      }
                    }
                  },
                  "query": {
                    "bool": {
                      "filter": {
                        "range": {
                          "@timestamp": {
                            "lte": "now",
                            "gte": "now-{{ctx.metadata.window}}"
                          }
                        }
                      }
                    }
                  }
                }
            }
        }
    },
    "condition": {
        "script": {
            "inline":"def threshold=ctx.metadata.threshold; def hosts = ctx.payload.aggregations.per_host.buckets; if (hosts.size() == 0) return false; return hosts.stream().anyMatch(p -> p.per_minute.buckets[p.per_minute.buckets.length - 1].iowait_deriv.value > threshold);"
        }
    },
    "actions": {
        "log": {
            "transform": {
                "script": {
                    "inline":"def threshold=ctx.metadata.threshold; def hosts = ctx.payload.aggregations.per_host.buckets; return hosts.stream().filter(p -> p.per_minute.buckets[p.per_minute.buckets.length - 1].iowait_deriv.value > threshold).map(e -> ['key': e.key, 'value': e.per_minute.buckets[e.per_minute.buckets.length - 1].iowait_deriv.value]).collect(Collectors.toList());"
                }
            },
	    "logging": {
		  "text": "The following hosts iowait cpu usage has increased dramatically over the last {{ctx.metadata.interval}}: {{#ctx.payload._value}}{{key}}:{{value}}% iowait change:{{/ctx.payload._value}}"
	      }
        }
    }
}